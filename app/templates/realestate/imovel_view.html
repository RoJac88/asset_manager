{% extends "base.html" %}

{% block scripts %}
  {{ super() }}
  <script>
    $(function() {

      var chart_data = [];
      var chart_labels = [];

      $(".chart-label").each(function(index) {
        chart_labels.push($(this).text());
      });
      $(".chart-data").each(function(index) {
        var shares = parseInt($(this).text());
        chart_data.push(shares);
      });

      console.log(chart_data);
      console.log(chart_labels);

      new Chart(document.getElementById("owners-chart"), {
        type: 'doughnut',
        data: {
          labels: chart_labels,
          datasets: [
            {
              label: "Shares distribution",
              backgroundColor: ["#003f5c", "#d45087","#ffa600","#665191", "#ff7c43", "#2f4b7c", "#a05195", "#f95d6a"],
              data: chart_data
            }
          ]
        },
        options : {
          title: {
            display: false,
            text: "Distribution of Shares"
          }
        }
      });

      $("#add_own").on('click', function() {
        var $newOwner = $('.owner_form').last().clone();
        $newOwner.find("input[type='text']").val("");
        var tags = $newOwner.children().prop("for").split("-");
        var index = parseInt(tags[1], 10);
        var next = index + 1;
        if (($newOwner).find(".btn-danger.form-control").length == 0) {
          var $inner = $("<span/>", {"class": "glyphicon glyphicon-trash"});
          var $outter = $("<button/>", {"class": "btn btn-danger btn-sm form-control", "id": next});
          $newOwner.append($outter.append($inner.append()))
        } else {
          $newOwner.find(".btn-danger").last().attr({id: next});
        };
        var ownerTag = "owners-"+index+"-owner";
        var shareTag = "owners-"+index+"-share";
        var ownerTagNext = "owners-"+next+"-owner";
        var shareTagNext = "owners-"+next+"-share";
        $($newOwner).find(".owner_id_label").last().attr("for", ownerTagNext);
        $($newOwner).find(".owner_id").last().attr({
          id: ownerTagNext,
          name: ownerTagNext,
          }).on('input', function() {
            if ($(this).val().length >= 11) {
              var index = parseInt(this.id.split("-")[1], 10);
              $.getJSON($SCRIPT_ROOT + '/_get_person', {
                id: $(this).val(),
              }, function(data) {
                $('#info-'+index).val(data["name"]);
              });
            }
          });
        $($newOwner).find(".owner_share_label").last().attr("for", shareTagNext);
        $($newOwner).find(".owner_share").last().attr({
          id: shareTagNext,
          name: shareTagNext,
          });
        $($newOwner).find(".btn-danger.form-control").last().on('click', function() {
          $(this).parent().remove();
          $('#info-'+this.id).remove();
          });
        $newOwner.appendTo("#estate_owners");
        $("#estate_owners").find("div").last().removeClass("owner_id-"+index).addClass("owner_id-"+next);
        var $info = $("<input id=info-"+next+" class='form-control owner-info' style='height:39px' type='text' value='' disabled>");
        var $divInfo = $('<div/>', {
          "class": 'form-group from-inline owner-info-'+next,
        });
        $($info).appendTo($divInfo)
        $divInfo.appendTo("#owners_info")
        });

      $('.btn-danger.form-control').on('click', function() {
        $(this).parent().remove();
        $('#info-'+this.id).remove();
      });

      $(".owner_id").on('input', function() {
        if ($(this).val().length >= 11) {
          var index = parseInt(this.id.split("-")[1], 10);
          $.getJSON($SCRIPT_ROOT + '/_get_person', {
            id: $(this).val(),
          }, function(data) {
            $('#info-'+index).val(data["name"]);
          });
        }
      });

      $("#addr_cep").on('input', function() {
        if ($(this).val().length == 8) {
          $.getJSON($SCRIPT_ROOT + '/cep', {
            cep: $('input[name="addr_cep"]').val(),
          }, function(data) {
            $("[id='addr_cidade']").val(data["cidade"]);
            $("[id='addr_uf']").val(data["uf"]);
            $("[id='addr_bairro']").val(data["bairro"]);
            $("[id='addr_rua']").val(data["rua"]);
            $("[id='addr_num']").val(data["num"]);
            $("[id='addr_compl']").val(data["compl"]);
          });
        }
      });
    });
  </script>
{% endblock %}

{% block app_content %}
{% if imovel != None %}
<div class="container">
  <div class="row">
    <div class="col-xs-5">
      <div class="panel panel-default">
      	<div class="panel-heading text-center panel-headstyle"><h4>Real Estate Info</h4></div>
      	<div class="panel-body">
      		<p><strong>{{ imovel.name }}</strong></p>
          <p>{{ imovel.addr_rua }}, {{ imovel.addr_num }} - {{ imovel.addr_compl }}</p>
          <p>{{ imovel.addr_bairro }}</p>
          <p>{{ imovel.addr_cidade }} - {{ imovel.addr_uf }}</p>
          <p>{{ imovel.addr_cep[:-3] }}-{{ imovel.addr_cep[-3:] }}</p>
        </div>
        {% if current_user.is_authenticated %}
        <div class="panel-footer">
          <button type="button" class="btn btn-warning btn-xs" data-toggle="modal" data-target="#edit_contact"><span class="glyphicon glyphicon-pencil"></span> Edit</button>
        </div>
        {% endif %}
      </div>
    </div>
    <div class="col-xs-7">
      <p>Mapa</p>
    </div>
  </div>
  <div class="row">
    <div class="panel panel-default">
      <div class="panel-heading text-center panel-headstyle"><h4>Owners</h4></div>
      <div class="panel-body">
        <div class="col-xs-7">
          <table id="owners" class="table table-striped table-hover table-condensed">
        		<thead>
        			<tr>
        				<th>CPF / CNPJ</th>
        				<th>Name</th>
        				<th>Shares</th>
        			</tr>
        		</thead>
        		<tbody>
        		{% for owner in owners %}
        		{% include 'realestate/_owner.html' %}
        		{% endfor %}
        		</tbody>
            {% if unknown_shares > 0 %}
            <tfoot>
              <tr>
                <td> </td>
              	<td class="chart-label">UNKNOWN SHARES</td>
              	<td class="chart-data">{{ unknown_shares }}</td>
              </tr>
            </tfoot>
            {% endif %}
        	</table>
        <p><strong>Total Shares: {{ imovel.total_shares }}</strong></p>
        {% if current_user.is_authenticated %}
        <div class="panel-footer">
          <button type="button" class="btn btn-warning btn-xs" data-toggle="modal" data-target="#edit_owners"><span class="glyphicon glyphicon-pencil"></span> Edit</button>
        </div>
        {% endif %}
      </div>
      <div class="col-xs-5">
        <canvas id="owners-chart"></canvas>
      </div>
    </div>
  </div>
  <div class="row">
    <div class="panel panel-default">
      <div class="panel-heading text-center panel-headstyle"><h4>Matricula: {{ imovel.matricula_n }}</h4></div>
      <div class="panel-body">
        {% if imovel.matricula_file %}
        <div class="col-xs-1">
          <img src="{{ url_for('static', filename='pdf.png') }}" class="img-responsive" width=48 height=48>
        </div>
        <div class="col-xs-3">
          <p><strong> {{ moment(imovel.matricula_file_date).format('LL') }}</strong></p>
          <a href="{{ url_for('main.download_file', filepath=imovel.matricula_file) }}">
      		  <button type="button" class="btn btn-success btn-sm"><span class="glyphicon glyphicon-download-alt"></span> Download</button>
      		</a>
          <button type="button" class="btn btn-info btn-sm" data-toggle="collapse" data-target="#matricula"><span class="glyphicon glyphicon-refresh"></span> Update</button>
        </div>
        <div class="col-xs-8">
    			<div class="collapse" id="matricula">
    				<form method="post" action="" class="form-inline" role="form" enctype="multipart/form-data">
    					<div class = "form-group">
    				    {{ mat_form.csrf_token }}
    				    {{ mat_form.matricula_file.label(class="control-label") }}
    						{{ mat_form.matricula_file(class="form-control") }}
    					</div>
    					<div class ="form-group">
    						{{ mat_form.matricula_file_date.label() }}
    						{{ mat_form.matricula_file_date(class="form-control") }}
    					</div>
    					<div class ="form-group required">
    						{{ mat_form.submit_mat.label(class="sr-only") }}
    						{{ mat_form.submit_mat(class="form-control btn-success") }}
    					</div>
    				</form>
    			</div>
    		</div>
        {% else %}
        <div class="col-xs-3">
          <button type="button" class="btn btn-success" data-toggle="collapse" data-target="#matricula"><span class="glyphicon glyphicon-plus"></span> Add PDF</button>
        </div>
        <div class="col-xs-9">
          <div class="collapse" id="matricula">
    				<form method="post" action="" class="form-inline" role="form" enctype="multipart/form-data">
    					<div class = "form-group">
    				    {{ mat_form.csrf_token }}
    				    {{ mat_form.matricula_file.label(class="control-label") }}
    						{{ mat_form.matricula_file(class="form-control") }}
    					</div>
    					<div class ="form-group">
    						{{ mat_form.matricula_file_date.label() }}
    						{{ mat_form.matricula_file_date(class="form-control") }}
    					</div>
    					<div class ="form-group required">
    						{{ mat_form.submit_mat.label(class="sr-only") }}
    						{{ mat_form.submit_mat(class="form-control btn-success") }}
    					</div>
    				</form>
    			</div>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
  <div class="row">
    <div class="well">
      <p>Last modification: {{ moment(imovel.last_edit_time).fromNow() }}, by: <span class="label label-success">{{ imovel.editor }}</span>
        {% if current_user.is_authenticated %}
        <a href="{{ url_for('realestate.delete_imovel', imovel_id=imovel.id) }}"
          <button type="button" class="btn btn-lg btn-danger pull-right"><span class="glyphicon glyphicon-trash"></span></button>
        </a>
        {% endif %}
      </p>
      <p>Created: {{ moment(imovel.timestamp).format('LLLL') }}, by: <span class="label label-success">{{ imovel.creator }}</span></p>
    </div>
  </div>
</div>

{% include 'realestate/_edit_contact.html' %}

{% include 'realestate/_edit_owners.html' %}

{% else %}
<img src="http://www.quickmeme.com/img/a8/a8022006b463b5ed9be5a62f1bdbac43b4f3dbd5c6b3bb44707fe5f5e26635b0.jpg" class="img-responsive">
{% endif %}
{% endblock %}
